@startuml diagramme_classes_ServeurData
!theme plain
skinparam classAttributeIconSize 0
skinparam backgroundColor #FFFFFF
skinparam roundcorner 10

title Diagramme de Classes - Serveur Data (REST API + Stockage)

package "Serveur Data" {
    
    ' ==== API REST ====
    class DataAPI {
        - app : Flask/FastAPI
        - dataset_service : DatasetService
        - model_service : ModelService
        - context_service : ContextService
        --
        + post_datasets(data: dict) : dict
        + get_datasets() : list
        + get_dataset_by_id(id: str) : dict
        + delete_dataset(id: str) : dict
        + post_models(model_data: dict) : dict
        + get_models() : list
        + get_model_by_id(id: str) : dict
        + delete_model(id: str) : dict
    }
    
    ' ==== Modèles de Domaine ====
    class Dataset {
        - id : str
        - name : str
        - timestamps : List[datetime]
        - values : List[float]
        - created_at : datetime
        - size : int
        - date_debut : datetime
        - date_fin : datetime
        - metadata : dict
        --
        + __init__(name: str, timestamps, values)
        + validate() : bool
        + get_date_range() : tuple
        + filter_by_dates(debut: str, fin: str) : Dataset
        + to_dict() : dict
        + from_dict(data: dict) : Dataset
    }
    
    class SavedModel {
        - id : str
        - name : str
        - model_type : str
        - state_dict_path : str
        - created_at : datetime
        - version : str
        - file_size : int
        --
        + __init__(name: str, model_type: str, state_dict: bytes)
        + save_state_dict(data: bytes) : str
        + load_state_dict() : bytes
        + to_dict() : dict
        + from_dict(data: dict) : SavedModel
    }
    
    class Context {
        - id : str
        - model_id : str
        - architecture : dict
        - training_params : dict
        - normalization_params : dict
        - test_metrics : dict
        - training_history : list
        - created_at : datetime
        --
        + __init__(model_id: str, **kwargs)
        + add_training_history(epoch: int, loss: float) : void
        + set_test_metrics(metrics: dict) : void
        + to_dict() : dict
        + from_dict(data: dict) : Context
    }
    
    ' ==== Services Métier ====
    class DatasetService {
        - storage : IStorage
        --
        + create_dataset(data: dict) : Dataset
        + get_all_datasets() : list
        + get_dataset_by_id(id: str) : Dataset
        + delete_dataset(id: str) : bool
        + check_name_exists(name: str) : bool
        - _generate_id() : str
    }
    
    class ModelService {
        - storage : IStorage
        --
        + save_model(model_data: dict) : SavedModel
        + get_all_models() : list
        + get_model_by_id(id: str) : SavedModel
        + delete_model(id: str) : bool
        + get_model_with_context(id: str) : dict
    }
    
    class ContextService {
        - storage : IStorage
        --
        + create_context(context_data: dict) : Context
        + get_context_by_model_id(model_id: str) : Context
        + update_context(id: str, data: dict) : Context
        + delete_context(id: str) : bool
    }
    
    ' ==== Interface de Stockage ====
    interface IStorage {
        + save(key: str, data: Any) : void
        + load(key: str) : Any
        + delete(key: str) : void
        + exists(key: str) : bool
        + list_keys(prefix: str) : list
    }
    
    ' ==== Implémentations du Stockage ====
    class FileSystemStorage {
        - base_path : Path
        - datasets_dir : Path
        - models_dir : Path
        - contexts_dir : Path
        --
        + __init__(base_path: str)
        + save(key: str, data: Any) : void
        + load(key: str) : Any
        + delete(key: str) : void
        + exists(key: str) : bool
        + list_keys(prefix: str) : list
        - _ensure_directories() : void
    }
    
    class DatabaseStorage {
        - connection_string : str
        - engine : Engine
        - session : Session
        --
        + __init__(connection_string: str)
        + save(key: str, data: Any) : void
        + load(key: str) : Any
        + delete(key: str) : void
        + exists(key: str) : bool
        + list_keys(prefix: str) : list
        - _connect() : void
    }
    
    class S3Storage {
        - bucket_name : str
        - client : boto3.Client
        - region : str
        --
        + __init__(bucket: str, region: str)
        + save(key: str, data: Any) : void
        + load(key: str) : Any
        + delete(key: str) : void
        + exists(key: str) : bool
        + list_keys(prefix: str) : list
    }
    
    ' ==== Utilitaires ====
    class ValidationHelper {
        --
        + {static} validate_time_series(timestamps, values) : bool
        + {static} validate_model_data(data: dict) : bool
        + {static} check_unique_name(name: str, existing: list) : bool
    }
    
    class SerializationHelper {
        --
        + {static} serialize_to_json(obj: Any) : str
        + {static} deserialize_from_json(json_str: str) : Any
        + {static} encode_state_dict(state_dict: dict) : str
        + {static} decode_state_dict(encoded: str) : dict
    }
    
    ' ==== Relations ====
    DataAPI --> DatasetService : utilise
    DataAPI --> ModelService : utilise
    DataAPI --> ContextService : utilise
    
    DatasetService --> Dataset : gère
    ModelService --> SavedModel : gère
    ContextService --> Context : gère
    
    DatasetService --> IStorage : utilise
    ModelService --> IStorage : utilise
    ContextService --> IStorage : utilise
    
    IStorage <|.. FileSystemStorage : implémente
    IStorage <|.. DatabaseStorage : implémente
    IStorage <|.. S3Storage : implémente
    
    SavedModel "1" -- "1" Context : associé à
    
    DataAPI ..> ValidationHelper : utilise
    DataAPI ..> SerializationHelper : utilise
}

note right of IStorage
  Strategy Pattern
  Permet de changer facilement
  le backend de stockage
end note

note bottom of DataAPI
  Point d'entrée REST
  pour toutes les opérations
  sur les données et modèles
end note

@enduml
