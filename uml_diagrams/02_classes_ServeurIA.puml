@startuml diagramme_classes_ServeurIA
!theme plain
skinparam classAttributeIconSize 0
skinparam backgroundColor #FFFFFF
skinparam roundcorner 10

title Diagramme de Classes - Serveur IA (FastAPI + PyTorch)

package "Serveur IA" {
    
    ' ==== API FastAPI ====
    class FastAPIApp {
        - app : FastAPI
        - router : APIRouter
        --
        + post_train_full(payload: PaquetComplet, payload_model: dict) : StreamingResponse
        + get_root() : dict
        + get_models() : list
        + post_predict(data: dict) : dict
    }
    
    ' ==== Modèles Pydantic ====
    class TimeSeriesData <<Pydantic>> {
        + timestamps : List[datetime]
        + values : List[Optional[float]]
        --
        + model_post_init() : void
    }
    
    class PaquetComplet <<Pydantic>> {
        + Parametres_temporels : Optional[Parametres_temporels]
        + Parametres_choix_reseau_neurones : Optional[Parametres_choix_reseau_neurones]
        + Parametres_choix_loss_fct : Optional[Parametres_choix_loss_fct]
        + Parametres_optimisateur : Optional[Parametres_optimisateur]
        + Parametres_entrainement : Optional[Parametres_entrainement]
        + Parametres_visualisation_suivi : Optional[Parametres_visualisation_suivi]
    }
    
    class Parametres_archi_reseau_MLP <<Pydantic>> {
        + nb_couches : Optional[int]
        + hidden_size : Optional[int]
        + dropout_rate : Optional[float]
        + fonction_activation : Optional[str]
    }
    
    class Parametres_archi_reseau_CNN <<Pydantic>> {
        + nb_couches : Optional[int]
        + hidden_size : Optional[int]
        + kernel_size : Optional[int]
        + stride : Optional[int]
        + padding : Optional[int]
        + fonction_activation : Optional[str]
    }
    
    class Parametres_archi_reseau_LSTM <<Pydantic>> {
        + nb_couches : Optional[int]
        + hidden_size : Optional[int]
        + bidirectional : Optional[bool]
        + batch_first : Optional[bool]
    }
    
    ' ==== Modèles PyTorch (Abstract) ====
    abstract class NeuralNet <<PyTorch>> {
        # input_size : int
        # output_size : int
        --
        + {abstract} forward(x: Tensor) : Tensor
        # _init_weights() : void
        + get_num_parameters() : int
    }
    
    ' ==== Modèles Concrets ====
    class MLP <<PyTorch>> {
        - layers : nn.ModuleList
        - dropout : nn.Dropout
        - batch_norm : nn.BatchNorm1d
        - hidden_size : int
        - nb_couches : int
        - activation : str
        --
        + __init__(input_size: int, output_size: int, config: dict)
        + forward(x: Tensor) : Tensor
        - _create_layers() : void
        - _get_activation(name: str) : nn.Module
    }
    
    class CNN <<PyTorch>> {
        - conv_layers : nn.ModuleList
        - fc_layers : nn.ModuleList
        - kernel_size : int
        - stride : int
        - padding : int
        --
        + __init__(input_size: int, output_size: int, config: dict)
        + forward(x: Tensor) : Tensor
        - _calculate_conv_output_size() : int
    }
    
    class LSTM <<PyTorch>> {
        - lstm : nn.LSTM
        - fc : nn.Linear
        - hidden_size : int
        - nb_couches : int
        - bidirectional : bool
        --
        + __init__(input_size: int, output_size: int, config: dict)
        + forward(x: Tensor) : Tensor
        + init_hidden(batch_size: int) : tuple
    }
    
    ' ==== Factory Pattern ====
    class ModelFactory {
        --
        + {static} create(model_type: str, config: dict) : NeuralNet
        - {static} _validate_config(model_type: str, config: dict) : void
    }
    
    ' ==== Strategy Pattern - Loss ====
    class LossFactory {
        --
        + {static} create(loss_name: str, params: dict) : nn.Module
    }
    
    ' ==== Strategy Pattern - Optimizer ====
    class OptimizerFactory {
        --
        + {static} create(optimizer_name: str, model_params, lr: float, weight_decay: float) : Optimizer
    }
    
    ' ==== Entraînement ====
    class Trainer {
        - model : NeuralNet
        - criterion : nn.Module
        - optimizer : Optimizer
        - device : str
        - history : list
        --
        + __init__(model: NeuralNet, criterion, optimizer, device: str)
        + train_epoch(X: Tensor, y: Tensor, batch_size: int) : dict
        + compute_gradient_norm() : float
        + save_checkpoint(path: str) : void
        + load_checkpoint(path: str) : void
    }
    
    ' ==== Préparation des Données ====
    class DataPreprocessor {
        - normalization_params : dict
        --
        + filter_series_by_dates(timestamps, values, dates) : tuple
        + build_supervised_tensors(values, horizon, step) : tuple
        + normalize_data(data: Tensor, method: str) : tuple
        + create_inverse_function(params: dict) : Callable
        + split_train_test(X, y, portion: float) : tuple
    }
    
    ' ==== Testing ====
    class TestingModule {
        --
        + test_model(model, X_test, y_test, inverse_fn, batch_size, device) : Generator
        + compute_metrics(y_true, y_pred) : dict
        - _calculate_mse(y_true, y_pred) : float
        - _calculate_mae(y_true, y_pred) : float
        - _calculate_rmse(y_true, y_pred) : float
        - _calculate_mape(y_true, y_pred) : float
        - _calculate_r2(y_true, y_pred) : float
    }
    
    ' ==== SSE Streaming ====
    class SSEStreamer {
        --
        + {static} format_sse(data: dict) : str
        + {static} stream_training_events(training_gen: Generator) : Generator
    }
    
    ' ==== Proxy vers Serveur Data ====
    class DataServerProxy {
        - base_url : str
        - session : requests.Session
        --
        + get_dataset(dataset_id: str) : TimeSeriesData
        + save_model(model_data: dict) : str
        + get_model(model_id: str) : dict
        + list_datasets() : list
        + list_models() : list
    }
    
    ' ==== Relations ====
    NeuralNet <|-- MLP : hérite
    NeuralNet <|-- CNN : hérite
    NeuralNet <|-- LSTM : hérite
    
    ModelFactory ..> NeuralNet : crée
    ModelFactory ..> MLP : instancie
    ModelFactory ..> CNN : instancie
    ModelFactory ..> LSTM : instancie
    
    FastAPIApp --> PaquetComplet : reçoit
    FastAPIApp --> Trainer : utilise
    FastAPIApp --> DataPreprocessor : utilise
    FastAPIApp --> TestingModule : utilise
    FastAPIApp --> SSEStreamer : utilise
    FastAPIApp --> DataServerProxy : utilise
    
    Trainer --> NeuralNet : entraîne
    Trainer --> LossFactory : utilise
    Trainer --> OptimizerFactory : utilise
    
    PaquetComplet o-- Parametres_archi_reseau_MLP
    PaquetComplet o-- Parametres_archi_reseau_CNN
    PaquetComplet o-- Parametres_archi_reseau_LSTM
}

note right of ModelFactory
  Factory Pattern
  Crée dynamiquement le bon
  type de modèle selon config
end note

note bottom of LossFactory
  Strategy Pattern
  Sélectionne la fonction
  de perte appropriée
end note

note bottom of DataServerProxy
  Proxy Pattern
  Interface unique vers
  le Serveur Data
end note

@enduml
