@startuml
skinparam backgroundColor #FEFEFE
skinparam sequenceArrowThickness 2

title Diagramme de Séquence - Stratégies de Prédiction

participant "TrainingPipeline" as TP #E8F6F3
participant "predict_multistep" as PM #EBF5FB
participant "Model\n(PyTorch)" as M #FDEDEC

TP -> PM: predict_multistep(model, config)
activate PM

PM -> PM: model.eval()
PM -> PM: Extraire fenêtre initiale

PM -->> TP: yield {"type": "pred_start"}

alt strategy == ONE_STEP
  loop Pour chaque pas
    PM -> M: forward(window)
    M --> PM: pred_norm
    PM -> PM: denormalize
    PM -> PM: uncertainty = residual_std
    PM -> PM: low/high = pred ± z*σ
    PM -->> TP: yield {"type": "pred_point"}
    PM -> PM: Recalibration immédiate
  end

else strategy == RECALIBRATION
  loop Pour chaque pas
    PM -> M: forward(window)
    M --> PM: pred_norm
    PM -> PM: uncertainty = σ * sqrt(steps+1)
    PM -->> TP: yield {"type": "pred_point"}
    alt steps >= recalib_every
      PM -> PM: Recalibration
    else
      PM -> PM: window[-1] = pred
    end
  end

else strategy == RECURSIVE
  loop Pour chaque pas
    PM -> M: forward(window)
    M --> PM: pred_norm
    PM -> PM: uncertainty croissante
    PM -->> TP: yield {"type": "pred_point"}
    PM -> PM: window[-1] = pred (jamais recalib)
  end

else strategy == DIRECT
  loop Chunks de H pas
    PM -> M: forward(window)
    M --> PM: [pred_1, ..., pred_H]
    loop h = 1 à H
      PM -->> TP: yield {"type": "pred_point"}
    end
    PM -> PM: Shift window de H
  end
end

PM -> PM: compute_metrics()
PM -->> TP: yield {"type": "pred_end", "metrics": {...}}

deactivate PM

@enduml